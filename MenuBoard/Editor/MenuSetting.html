<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>메뉴 선택</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/multi-select.css">
    <script src="../assets/js/vendor/jquery-3.1.1.min.js"></script>
    <!-- Foundation CSS framework (Bootstrap and jQueryUI also supported) -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/foundation/5.0.2/css/foundation.min.css'>
    <!-- Font Awesome icons (Bootstrap, Foundation, and jQueryUI also supported) -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <style type="text/css">
        .row {
            max-width: 100%;
        }
    </style>
    <script src="dist/jsoneditor.js"></script>
</head>
<body>
    <div style="width:100%;">
        <button type="button" title="Back" class="button tiny" style="margin:10px;" onclick="history.back();"><i class="fa fa-arrow-left"></i> 뒤로</button>
    </div>
    <h1>메뉴 선택</h1>
    <div id="divMenus"></div>

    <button id='submit' style="margin:10px;" onclick="saveMenuSetting();">저장</button>
    <button id='submit' style="margin:10px;" onclick="refreshMenus();">초기화</button>
    
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>
    <script src="dist/jquery.multi-select.js"></script>
    <script src="dist/jquery.quicksearch.js"></script>
    <script>
        var saveStorage;
        var menus;
        $(document).ready(function () {
            $.getJSON('config.json', function (data) {
                
                var page = getUrlParameter('page');
                $(data.PageSetting).each(function (idx, obj) {
                    if (obj.Page == page) {
                        menus = obj.setting.list;
                    }
                });

                $.getJSON('menu.json', function (data) {
                    $(menus).each(function (listIdx, listObj) {
                        //select박스 동적 생성
                        var select = $('<select></select>').attr('id', listObj.menuId).attr('max', listObj.maxItems).attr('min', listObj.minItems).attr('multiple', 'multiple');
                                            
                        $(data.menu).each(function (menuIdx, menuObj) {
                            $(select).append("<option value='" + menuObj.Id + "'>" + menuObj.Name + "</option>");
                        });

                        $('#divMenus').append(select);
                        $(select).multiSelect({
                            keepOrder: true,
                            selectableFooter: "<div class='custom-header'><br><br></div>",  
                            selectionFooter: "<div class='custom-header'><br><br></div>",
                            selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='검색'>",
                            selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='검색'>",
                            afterInit: function (ms) {
                                var that = this,
                                    $selectableSearch = that.$selectableUl.prev(),
                                    $selectionSearch = that.$selectionUl.prev(),
                                    selectableSearchString = '#' + that.$container.attr('id') + ' .ms-elem-selectable:not(.ms-selected)',
                                    selectionSearchString = '#' + that.$container.attr('id') + ' .ms-elem-selection.ms-selected';

                                that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                                .on('keydown', function (e) {
                                    if (e.which === 40) {
                                        that.$selectableUl.focus();
                                        return false;
                                    }
                                });
                                that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                                .on('keydown', function (e) {
                                    if (e.which == 40) {
                                        that.$selectionUl.focus();
                                        return false;
                                    }
                                });
                            },
                            afterSelect: function () {
                                this.qs1.cache();
                                this.qs2.cache();
                                var maxId = $(select).attr('id');
                                var maxItems = $(select).attr('max');

                                if (maxItems < $('#ms-' + $(select).attr('id') + ' > .ms-selection > ul.ms-list > li.ms-selected').length) {
                                    $('#divMenus').find(select).multiSelect('deselect_all');
                                    alert("더이상 추가할 수 없습니다." + " (" + maxItems + "개 항목까지 추가 가능)");
                                    return false;                                   
                                }
                            }                            
                        });
                    });
                });
            });
        }); 

            function getUrlParameter(sParam) {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;

                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };

            function createJSON(page) {
                $.getJSON('menu.json', function (data) {
                    $(menus).each(function (menuIdx, menuObj) {
                        var select = $('<select></select>').attr('Id', menuObj.menuId).attr('Name', menuObj.Name).attr('SubName', menuObj.Image).attr('Price1', menuObj.Price1).attr('Price2', menuObj.Price2).attr('Price3', menuObj.Price3).attr('Description1', menuObj.Description1).attr('Description2', menuObj.Description2).attr('Tag', menuObj.Tag);
                    })
                        $.getJSON('../Pages/PT00' + page + '/data/menuData.json', function (data) {
                            $(data).$('#ms-' + $(select).attr('id') + ' > .ms-selection > ul.ms-list > li.ms-selected').each(function (idx, obj) {
                                $(data.menu).add('Id', menuObj.menuId).add('Name', menuObj.Name).add('SubName', menuObj.Image).add('Price1', menuObj.Price1).add('Price2', menuObj.Price2).add('Price3', menuObj.Price3).add('Description1', menuObj.Description1).add('Description2', menuObj.Description2).add('Tag', menuObj.Tag);
                            })

                            localStorage.setItem = ('Id', 'data.menu.Id');
                            saveStorage = localStorage.getItem('Id');
                        })
                })
            };

            function refreshMenus() {
                $('#divMenus').find('select').each(function (Idx) {
                    $(this).multiSelect('deselect_all');
                });
            };

            function saveMenuSetting() {
                $.getJSON('config.json', function (data) {
                    var menus;
                    var page = getUrlParameter('page');

                    $(data.PageSetting).each(function (idx, obj) {
                        if (obj.Page == page) {
                            menus = obj.setting.list;
                        }
                    });

                    $.getJSON('menu.json', function (data) {
                        $(menus).each(function (listIdx, listObj) {
                            var select = $('<select></select>').attr('id', listObj.menuId).attr('min', listObj.minItems);
                            var minItems = $(select).attr('min');
                            var menuId = $(select).attr('id');
                            var lastIdx = menus.length;

                            if (menuId == 'menu' + (listIdx + 1) && (minItems > $('#ms-' + $(select).attr('id') + ' > .ms-selection > ul.ms-list > li.ms-selected').length)) {
                                alert(menuId + " 에 " + minItems + " 가지 이상 파일을 추가 해주세요. ");
                            } else if
                                ($(menus).each(function (listIdx, listObj) {
                                menuId == 'menu' + (lastIdx - 1) && (minItems <= $('#ms-' + $(select).attr('id') + ' > .ms-selection > ul.ms-list > li.ms-selected').length)
                            })) {
                                if (menuId == 'menu' + lastIdx && (minItems <= $('#ms-' + $(select).attr('id') + ' > .ms-selection > ul.ms-list > li.ms-selected').length)) {
                                    var pageId = getUrlParameter('page');
                                    var menuInfo = createJSON(pageId);
                                    var value = $(saveStorage).getValue;
                                    
                                    localStorage.setItem('pageSetting' + pageId, JSON.stringify(value));
                                    alert(pageId + " 페이지 정보가 저장되었습니다.");
                                    //history.back();                                    
                                }
                            }
                        });
                    });
                });
            };
    </script>
</body>
</html>